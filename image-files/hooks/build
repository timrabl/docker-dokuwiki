#!/bin/sh
# hooks/build
# https://docs.docker.com/docker-cloud/builds/advanced/

# $IMAGE_NAME var is injected into the build so the tag is correct.
echo "[***] Build hook running"

C1=`echo ${DOCKER_TAG} | cut -d "-" -f 1`
C2=`echo ${DOCKER_TAG} | cut -d "-" -f 2`
C3=`echo ${DOCKER_TAG} | cut -d "-" -f 3`


IMD="image-files/"

if [ $C1 == "latest" ]; then
    if [ $C2 == "installer" ]; then
        if [ $C3 == "ldap" ]; then
            docker build --build-arg VERSION=stable --build-arg INSTALLER=true --build-arg LDAP=true -t dokuwiki:latest-installer-ldap $(IMD)
        fi
        docker build --build-arg VERSION=stable --build-arg INSTALLER=true -t dokuwiki:latest-installer $(IMD)
    elif [ $C2 == "ldap" ]; then
        if [ $C3 == "installer" ]; then
            docker build --build-arg VERSION=stable --build-arg INSTALLER=true --build-arg LDAP=true -t dokuwiki:latest-installer-ldap $(IMD)
        fi
        docker build --build-arg VERSION=stable --build-arg LDAP=true -t dokuwiki:latest-ldap $(IMD)
    else
        docker build --build-arg VERSION=stable -t dokuwiki:latest $(IMD)
elif [ $C1 == "rc" ]; then
    if [ $C2 == "installer" ]; then
        if [ $C3 == "ldap" ]; then
            docker build --build-arg VERSION=release-candidate --build-arg INSTALLER=true --build-arg LDAP=true -t dokuwiki:rc-installer-ldap $(IMD)
        fi
        docker build --build-arg VERSION=release-candidate --build-arg INSTALLER=true -t dokuwiki:rc-installer $(IMD)
    elif [ $C2 == "ldap" ]; then
        if [ $C3 == "installer" ]; then
            docker build --build-arg VERSION=release-candidate --build-arg INSTALLER=true --build-arg LDAP=true -t dokuwiki:rc-installer-ldap $(IMD)
        fi
        docker build --build-arg VERSION=release-candidate --build-arg LDAP=true -t dokuwiki:rc-ldap $(IMD)
    else
        docker build --build-arg VERSION=release-candidate -t dokuwiki:rc $(IMD)
    fi
fi
